var coinShortName=getRequestByName("shortName")||"bch",coinId=getRequestByName("id")||COIN[coinShortName][1],currentCoinRate=null;function btvs(){return Math.random()}function getPointNum(e){if(e)return 1<=e?e.toFixed(2):e.toFixed(8)}function history(){$.ajax({type:"GET",url:WebHelper.QueryHistory,data:"id="+coinId+"&t="+btvs(),async:!1,success:function(e){if("-2001"==e.status)return alert(e.msg),void(location.href="/");historyAddHtml(e,"api")}})}function trades(){var s={sell:{html:"",sn:1e3},buy:{html:"",sum:0,sn:1e3}};$.getJSON(WebHelper.QueryTrades+"?id="+coinId+"&t="+btvs(),function(e){var t=e.data;"undefined"==typeof BP&&(0<t.sell.length&&$("#buy-price").val(to_num(t.sell[0].fprize)),0<t.buy.length&&$("#sell-price").val(to_num(t.buy[0].fprize)),BP=1),$("#sell-price-index,#buy-price-well").html(0<t.sell.length?t.sell[0].fprize:0),$("#buy-price-index,#sell-price-well").html(0<t.buy.length?t.buy[0].fprize:0);for(var a=[],n=0,o=0,r=0;r<s.sell.sn;r++)void 0!==t.sell[r]&&(a[r]=n+=t.sell[r].fleftCount,o+=parseFloat(t.sell[r].fleftCount));for(r=s.sell.sn-1;0<=r;r--)if(void 0!==t.sell[r]){var l=100*(t.sell[r].fleftCount/o).toFixed(2);s.sell.html+='<dd  onclick="autotrust(this,\'sell\')"> <div  class="sidebar_bg_red" style="width: '+l+'%"></div> <div class="w_33t red">'+lang("卖")+(r+1)+'</div> <div class="w_33p is_num"  >'+t.sell[r].fprize+'</div> <div class="w_33p is_num" data-point="'+pointData(coinShortName,"numberPre")+'">'+t.sell[r].fleftCount+'</div></div> <div style="display: none;" class="w_80">'+formatfloat(t.sell[r].fleftCount*t.sell[r].fprize,4,0)+"</div> </dd>"}var i=0;$("#orderbook-sell").html(s.sell.html);for(r=0;r<s.buy.sn;r++)void 0!==t.buy[r]&&(i+=parseFloat(t.buy[r].fleftCount));$("#orderbook-sell").scrollTop($("#orderbook-sell")[0].scrollHeight);for(r=n=0;r<s.buy.sn;r++)if(void 0!==t.buy[r]){s.buy.sum=FF.add(s.buy.sum,t.buy[r].fleftCount),n+=t.buy[r].fleftCount;l=100*(t.buy[r].fleftCount/i).toFixed(2);s.buy.html+='<dd onclick="autotrust(this,\'buy\')"> <div class="sidebar_bg_green" style="width: '+l+'%"></div><div class="w_33t green">'+lang("买")+(r+1)+'</div> <div class="w_33p is_num"  >'+t.buy[r].fprize+'</div> <div class="w_33p is_num" data-point="'+pointData(coinShortName,"numberPre")+'">'+t.buy[r].fleftCount+'</div></div> <div class="w_80" style="display: none;">'+formatfloat(t.buy[r].fleftCount*t.buy[r].fprize,4,0)+"</div> </dd>"}$("#orderbook-buy").html(s.buy.html),maxbuy(),goods_num(),setTimeout("trades()",5e3)})}function myorders(){TMPL.list(1,{url:WebHelper.QueryOrders,data:{symbol:coinId,flag:1},name:"orders"})}function order_cancel(e){$.get(WebHelper.CancelTrade,{id:e,token:$.cookie("token")},function(e){1===e.status?(alert(lang("撤销成功")),useToRefresh()):alert(lang(e.msg))})}function tradeadd(t){if(USER){var e="",a=$("#"+t+"-price").val()&&$("#"+t+"-number").val();return e="buy"==t?WebHelper.BuyTrade:WebHelper.SellTrade,a?"none"!=$(".pwdtrade").css("display")&&""==$("#"+t+"-pwtrade").val()?($("#tm-"+t).find("span").html(lang("密码不能为空")),void $("#tm-"+t).show().delay(2e3).fadeOut()):void(xian(t,"isStop")&&!confirm(lang("价格与市场价偏差过大，确认提交？"))||$.post(e,$("#form-tradeadd-"+t).serialize()+"&token="+$.cookie("token"),function(e){if(-9==e.status)return alert(lang("请登录后再操作")),clearCookie(),location.href="/user/login.html",!1;ltcb(e)&&(1==e.status?(alert(lang("操作成功")),$(".pwdtrade").hide(),useToRefresh()):($("#tm-"+t).find("span").html(lang(e.msg)),$("#tm-"+t).show().delay(2e3).fadeOut(),"pwtrade"==e.data&&(location.href="/security/upadteTradePw.html")))},"json")):($("#tm-"+t).find("span").html(lang("请输入价格和数量")),void $("#tm-"+t).show().delay(2e3).fadeOut())}confirm(lang("请登录后再操作"))&&(location.href="/user/login.html")}function useToRefresh(){myorders(),FINANCE=0,balance(),maxbuy()}function balance_cb(){$("#btc_balance").html(formatfloat(FINANCE.data.btc_balance,6)),$("#btc_lock").html(formatfloat(FINANCE.data.btc_lock,6)),$("#"+coinShortName+"_balance").html(FINANCE.data[coinShortName+"_balance"]),$("#"+coinShortName+"_lock").html(FINANCE.data[coinShortName+"_lock"])}function buytotal(){var e=Number($("#buy-number").val());isNaN(e)&&(e=0),$("#buy-total").html(to_num($("#buy-price").val()*e)),$("#sell-total").html(to_num($("#sell-price").val()*Number($("#sell-number").val())));var t=Number($("#sell-total").html()),a=Number($("#buy-total").html());null!=currentCoinRate&&(t="≈ "+(t*currentCoinRate[getLang_rate()+"Para"]).toFixed(2)+" "+getLang_rate(),a="≈ "+(a*currentCoinRate[getLang_rate()+"Para"]).toFixed(2)+" "+getLang_rate()),$("#sell_usd").html("（"+t+")"),$("#buy_usd").html("（"+a+")")}function setTab2(e,t,a){for(i=1;i<=a;i++){var n=document.getElementById(e+i),o=document.getElementById("con_"+e+"_"+i);n.className=i==t?"hover":"",o.style.display=i==t?"block":"none"}}function autotrust(e,t){var a="";a=""==e?to_num(t):$(e).children().eq(1).html(),$("#buy-price").val(a).css({color:"#222","font-size":"14px"}),$("#sell-price").val(a).css({color:"#222",fontSize:"14px"}),$(".dollarOrRmb_buy").html(getCurrencySymbol()+to_num(currentCoinRate[getLang_rate()+"Para"]*Number(a))),$(".dollarOrRmb_sell").html(getCurrencySymbol()+to_num(currentCoinRate[getLang_rate()+"Para"]*Number(a)))}function sell_max(){if(void 0===FINANCE.data)return!1;$("#sell-max").html(formatfloat(FINANCE.data[coinShortName+"_balance"],3)),$("#max-sell-input").html(to_num(FINANCE.data[coinShortName+"_balance"]))}function maxbuy(){if(FINANCE&&1!=FINANCE&&parseFloat($("#buy-price").val())){if(void 0===FINANCE.data)return!1;var e=FINANCE.data[allMarkets[localStorage.getItem("coinType")]+"_balance"]/parseFloat($("#buy-price").val());$("#buy-max").html(e),$("#buy-max-input").html(to_num(e,pointData(coinShortName,"numberPre")))}}function slider(){var e=["sell","buy"];for(var t in e)$("#slider_"+e[t]).slider({value:0,min:0,max:100,step:10,range:"min",slide:function(e,t){var a=$(t.handle).attr("data_slide"),n=parseFloat($("#"+a+"-max").text());isNaN(n)&&(n=0),$("#"+a+" .ui-slider-handle").addClass("ui-state-focus ui-state-active"),$("#"+a+"-number").val(Math.floor(n/100*t.value*1e3)/1e3),$("#ratio_num_"+a).text(t.value+"%")}})}localStorage.setItem("coinType",getRequestByName("coinType")||1),$("input[name='symbol']").each(function(){$(this).attr("value",coinId)}),$(function(){$(".finddeal_currency .coin-name").append('<span class="blod_span">'+coinShortName.toLocaleUpperCase()+"</span>/"+allMarkets[localStorage.getItem("coinType")].toUpperCase()),$(".chart-buy-all .coin-name").append('<span class="blod_span">'+coinShortName.toLocaleUpperCase()+"</span>"),$(".coin_40").addClass("coin_"+coinShortName+"_40"),$(".jy-email,#userinfo").hover(function(){$(".jy-email").addClass("selected"),$("#userinfo").addClass("selected").css("z-index",100),$(".header").css("z-index",-100),$(".hdslide").css("z-index",-100),$(".page").css("z-index",-100)},function(){$(".header").css("z-index",19),$(".email").removeClass("selected"),$("#userinfo").removeClass("selected"),$(".hdslide").css("z-index",0),$(".page").css("z-index","auto")}),history(),historyWs(),tradesWs(),myorders(),slider(),setInterval("buytotal()",500),setTimeout(function(){maxbuy(),sell_max()},500),delayDepthRander(),$("#chart-control .btn").click(function(){var e=$(this);e.hasClass("forbidBtn")||(e.addClass("btn_active").siblings().removeClass("btn_active"),k_line(e.html(),coinShortName.toUpperCase()))}),k_line("30m",coinShortName.toUpperCase())});var chart={ask:0,data:{"5m":[],"15m":[],"30m":[],"1h":[],"8h":[],"1d":[]}};function k_line(t,a){$.get(WebHelper.kLine,{fviFid:coinId},function(e){if(1==e.status){for(i in e.data)0!=e.data[i].length?(chart.data[i]=e.data[i],clearInterval(chart[i+"_interval"])):$("#chart-control").find("span:contains("+i+")").addClass("forbidBtn");randerChart(t,a,e)}})}function randerChart(l,e,t){Highcharts.setOptions({global:{useUTC:!1},colors:["#DD1111","#FF0000","#DDDF0D","#7798BF","#55BF3B","#DF5353","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353","#7798BF","#aaeeee"],lang:{loading:"Loading...",months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],decimalPoint:".",numericSymbols:["k","M","G","T","P","E"]},credits:{enabled:!1}});var s=chart.data[l],a=[],n=[];if(s.length<1)$(".kline_loading").html(lang("暂无内容"));else{for(i=0;i<s.length;i++)a.push([s[i][0],Number(s[i][1]),Number(s[i][3]),Number(s[i][4]),Number(s[i][2])]),n.push([s[i][0],Number(s[i][5])]);var o=[["week",[1]],["month",[1,2,3,4,6]]];Highcharts.StockChart({chart:{renderTo:"kline_canvasBox",height:375,zoomType:"x",events:{load:function(){clearInterval(chart[l+"_interval"]);var r=this.series;chart[l+"_interval"]=setInterval(function(){new WebSocket(WsApi.kLine+coinId);$.get(WebHelper.realTimeData+"?t="+Math.random(),{fviFid:coinId},function(e){if(0<e.data[l].length){var t=s.length,a=e.data[l][0];for(var n in a[0]!=s[t-1][0]&&(r[0].addPoint([a[0],Number(a[1]),Number(a[3]),Number(a[4]),Number(a[2])],!0,!0),r[1].addPoint([a[0],Number(a[5])],!0,!0)),e.data){if(0<e.data[n].length){var o=chart.data[n].length;e.data[n][0][0]!=chart.data[n][o-1][0]&&chart.data[n].push(e.data[n][0])}n!=l&&clearInterval(chart[n+"_interval"])}}})},6e4)}}},navigator:{margin:5},xAxis:{type:"datetime",dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%y-%m",year:"%Y"}},plotOptions:{candlestick:{lineColor:"#333",color:"#e55600",upColor:"#690"}},tooltip:{split:!1,shared:!0,xDateFormat:"%Y-%m-%d %H:%M %A",color:"#f0f",borderColor:"#058dc7"},rangeSelector:{buttons:[{type:"minute",count:60,text:"1h"},{type:"minute",count:120,text:"2h"},{type:"minute",count:360,text:"6h"},{type:"minute",count:720,text:"12h"},{type:"day",count:1,text:"1d"},{type:"week",count:1,text:"1w"},{type:"all",text:"ALL"}],selected:6,inputEnabled:!1},exporting:{enabled:!1,buttons:{exportButton:{enabled:!1},printButton:{enabled:!0}}},yAxis:[{crosshair:!0,labels:{style:{color:"#7CB5EC"},formatter:function(){return to_num(this.value)}},title:{text:lang("价格")+"["+e+"]",style:{color:"#7CB5EC"}},height:"70%",lineWidth:2,gridLineDashStyle:"Dash"},{labels:{style:{color:"#4572A7"},formatter:function(){return to_num(this.value,pointData(coinShortName,"numberPre"))}},title:{text:lang("成交量")+"["+e+"]",style:{color:"#4572A7"}},offset:0,top:"75%",height:"25%",lineWidth:2,gridLineDashStyle:"Dash",showLastLabel:!0}],series:[{animation:!0,name:lang("价格")+"["+e+"]",type:"candlestick",color:"#ff6767",lineColor:"#ff6767",upColor:"#1bc676",upLineColor:"#1bc676",tooltip:{pointFormatter:function(){return'<span style="color:'+this.color+';font-weight:100">●</span> <b> '+this.series.name+"</span><br><span>"+lang("开盘")+":"+to_num(this.open)+"</span><br><span>"+lang("最高")+":"+to_num(this.high)+"</span><br><span>"+lang("最低")+":"+to_num(this.low)+"</span><br><span>"+lang("收盘")+":"+to_num(this.close)+"</span><br>"}},dataGrouping:{units:o,enabled:!1},data:a},{animation:!0,name:lang("成交量")+"["+e+"]",type:"column",color:"#7CB5EC",tooltip:{pointFormatter:function(){return'<span style="color:'+this.color+';font-weight:100">●</span> <b> '+this.series.name+"</span>:"+to_num(this.y)}},dataGrouping:{units:o,enabled:!1},yAxis:1,data:n}]})}}function getKlineSeconds(e){switch(e){case"1m":return 6e4;case"5m":return 3e5;case"15m":return 9e5;case"30m":return 18e5;case"1h":return 36e5;case"8h":return 2e3;case"1d":return 864e5}}function getSubMenuGap(e){switch(e){case"5m":return 2;case"15m":return 3;case"30m":case"1h":return 4;case"8h":return 5;case"1d":return 6}}var depth_chart=new Highcharts.Chart({chart:{type:"area",renderTo:"depth_canvas"},title:{text:""},subtitle:{},credits:{enabled:!1},xAxis:{title:{text:lang("价格")+"["+coinShortName.toUpperCase()+"]"},labels:{formatter:function(){return to_num(this.value)}}},yAxis:{title:{text:lang("数量")+"["+coinShortName.toUpperCase()+"]"}},tooltip:{formatter:function(){return lang("价格")+":"+to_num(this.x)+"<br>"+lang("数量")+":"+to_num(this.y)}},plotOptions:{area:{fillOpacity:.5,marker:{enabled:!1,symbol:"circle",radius:2,states:{hover:{enabled:!0}}}}},series:[{name:lang("买"),color:"#81DAA6"},{name:lang("卖"),color:"#FFBAB8"}]});function delayDepthRander(){setTimeout(function(){1==$(".depthBox:visible").length&&depthRander(),delayDepthRander()},5e3)}function depthRander(){$.get(WebHelper.findDepthDataByFviFid,{fviFid:coinId},function(e){if(e.data){for(var t=e.data.buy.sort(function(e,t){return t[0]-e[0]}),a=e.data.sell.sort(function(e,t){return e[0]-t[0]}),n=[],o=[],r=0;r<t.length;r++)0!=r?t[r][0]<.5*t[0][0]||o.push([Number(t[r][0]),accAdd(Number(t[r][1]),o[r-1][1])]):o.push([Number(t[r][0]),Number(t[r][1])]);for(var l=0;l<a.length;l++)0!=l?a[l][0]>1.5*a[0][0]||n.push([Number(a[l][0]),accAdd(Number(a[l][1]),n[l-1][1])]):n.push([Number(a[l][0]),Number(a[l][1])]);depth_chart.series[0].setData(o),depth_chart.series[1].setData(n)}})}function accAdd(e,t){var a,n,o,r;try{a=e.toString().split(".")[1].length}catch(e){a=0}try{n=t.toString().split(".")[1].length}catch(e){n=0}if(r=Math.abs(a-n),o=Math.pow(10,Math.max(a,n)),0<r){var l=Math.pow(10,r);n<a?(e=Number(e.toString().replace(".","")),t=Number(t.toString().replace(".",""))*l):(e=Number(e.toString().replace(".",""))*l,t=Number(t.toString().replace(".","")))}else e=Number(e.toString().replace(".","")),t=Number(t.toString().replace(".",""));return(e+t)/o}function getCoinDetail(){$.get(WebHelper.coinDetail,{coinShortName:coinShortName},function(e){if(1==e.status&&e.data){$("#coinDetail_cont .kline_loading").hide(),$("#coinDetail_cont .coinDetail").show();var t=e.data;$("#coinDetail_cont .coin_name").html(t.fvirtualcointype.fname),$("#coinDetail_cont .coin_enName").html(t.fvirtualcointype.englishName),$("#coinDetail_cont .coin_shortName").html(t.fvirtualcointype.fShortName),$("#coinDetail_cont .releaseDate").html(jsonDateFormat(t.releaseTime,"yyyy-MM-dd")),$("#coinDetail_cont .cont").html(t.introduction),$("#coinDetail_cont .cont a").attr("target","_blank")}})}function tradesWs(){new WebSocket(WsApi.wsTradesApi+coinId).onmessage=function(e){var t={sell:{html:"",sn:1e3},buy:{html:"",sum:0,sn:1e3}},a=JSON.parse(e.data).data;"undefined"==typeof BP&&(0<a.S.length&&($("#buy-price").val(to_num(a.S[0][0])),$(".dollarOrRmb_buy").html(getCurrencySymbol()+to_num(currentCoinRate[getLang_rate()+"Para"]*Number(a.S[0][0])))),0<a.B.length&&($("#sell-price").val(to_num(a.B[0][0])),$(".dollarOrRmb_sell").html(getCurrencySymbol()+to_num(currentCoinRate[getLang_rate()+"Para"]*Number(a.B[0][0])))),BP=1),$("#sell-price-index,#buy-price-well").html(0<a.S.length?a.S[0][0]:0),$("#buy-price-index,#sell-price-well").html(0<a.B.length?a.B[0][0]:0);for(var n=[],o=0,r=0,l=0;l<t.sell.sn;l++)void 0!==a.S[l]&&(n[l]=o+=a.S[l][1],r+=parseFloat(a.S[l][1]));for(l=t.sell.sn-1;0<=l;l--)if(void 0!==a.S[l]){var i=100*(a.S[l][1]/r).toFixed(2);t.sell.html+='<dd  onclick="autotrust(this,\'sell\')"> <div  class="sidebar_bg_red" style="width: '+i+'%"></div> <div class="is_num red">'+a.S[l][0]+'</div> <div class="is_num" data-point="'+pointData(coinShortName,"numberPre")+'">'+a.S[l][1]+'</div><div class="is_num" data-point="'+pointData(coinShortName,"pricePre")+'">'+a.S[l][1]*a.S[l][0]+"</div> </dd>"}var s=0;$("#orderbook-sell").html(t.sell.html);for(l=0;l<t.buy.sn;l++)void 0!==a.B[l]&&(s+=parseFloat(a.B[l][1]));$("#orderbook-sell").scrollTop($("#orderbook-sell")[0].scrollHeight);for(l=o=0;l<t.buy.sn;l++)if(void 0!==a.B[l]){t.buy.sum=FF.add(t.buy.sum,a.B[l][1]),o+=a.B[l][1];i=100*(a.B[l][1]/s).toFixed(2);t.buy.html+='<dd onclick="autotrust(this,\'buy\')"> <div class="sidebar_bg_green" style="width: '+i+'%"></div><div class="is_num green"  >'+a.B[l][0]+'</div> <div class="is_num" data-point="'+pointData(coinShortName,"numberPre")+'">'+a.B[l][1]+'</div><div class="is_num" data-point="'+pointData(coinShortName,"pricePre")+'">'+a.B[l][1]*a.B[l][0]+"</div> </dd>"}$("#orderbook-buy").html(t.buy.html),maxbuy(),goods_num(),$("#docLoading").hide()}}function historyWs(){createWebSocket(WsApi.wsTransaction+coinId)}function historyAddHtml(e,t){var a=e.data,n="";currentCoinRate={CNYPara:a.CNY,HKDPara:a.HKD,JPYPara:a.JPY,KRWPara:a.KRW,RUBPara:a.RUB,USDPara:a.USD};for(var o=a.d?a.d.length:0,r=0;r<o;r++){var l=a.d[r],i=0==l[0]?"green":"red";0==l[0]?lang("买入"):lang("卖出");n+='<div><span class="is_num '+i+'">'+l[2]+'</span><span class="is_num" data-point="'+pointData(coinShortName,"numberPre")+'">'+l[3]+"</span><span>"+jsonDateFormat(l[1],"hh:mm:ss")+'</span><div class="clear"></div></div>'}var s=a.TR,c=(i=0<=s.INC?"+":"",0<s.INC?"green":0==s.INC?"":"red");0<o&&$("#book-dl-list .no-records").remove(),$("#book-dl-list").prepend(n=""==n?'<p class="no-records">'+lang("暂无记录")+"</p>":n),30<$("#book-dl-list>div").length&&$("#book-dl-list>div:last").remove(),$("#ticker-high").html(s.ODH),$("#ticker-low").html(s.ODL),$("#market-volume").html(s.ODT+" "+allMarkets[localStorage.getItem("coinType")].toUpperCase()),$(".showDollarOrRmb").html("≈"+getCurrencySymbol()+to_num(s[getLang_rate()])),$("#ticker-vol").html(s.ODTN+" "+coinShortName.toUpperCase()),$("#ticker-last").html(s.LDP),$("#reShow_ticker").html('<div class="'+c+'" onclick="autotrustNowprice('+$("#ticker-last").html()+')">'+to_num($("#ticker-last").html())+'<span class="upOrDown '+("green"==c?"marketUp":"marketDown")+'"></span></div><div class="small">'+$(".showDollarOrRmb").html()+"</div>"),$("#ticker-chg").addClass(c).html(i+s.INC+"%"),$(".all_coin_info .po_re").addClass(c),t&&$(".fee-span").html(100*s.FFR),goods_num(),buytotal()}function autotrustNowprice(e){autotrust("",e)}function createWebSocket(t){var a,n=!1,o={timeout:2e4,timeoutObj:null,serverTimeoutObj:null,reset:function(){return clearTimeout(this.timeoutObj),clearTimeout(this.serverTimeoutObj),this},start:function(){var e=this;this.timeoutObj=setTimeout(function(){a.send("heart"),e.serverTimeoutObj=setTimeout(function(){a.close()},e.timeout)},this.timeout)}};try{a=new WebSocket(t),function(){if(a.onopen=function(e){o.reset().start()},a.onmessage=function(e){o.reset().start(),"keep alive"!=e.data&&historyAddHtml(JSON.parse(e.data),"ws")},a.onclose=function(){r(t),console.log("ws closed")},a.onerror=function(){r(t),console.log("error")},a.data)a.data}()}catch(e){r(t)}function r(e){n||(n=!0,setTimeout(function(){createWebSocket(e),n=!1},2e3))}}